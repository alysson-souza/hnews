<app-page-container
  [class.lg:w-[60vw]]="sidebarService.isOpen()"
  class="lg:transition-[width] lg:duration-300"
>
  <div class="space-y-2 sm:space-y-3">
    <!-- Theme Settings Section -->
    <app-card class="block setting-section" role="region" aria-label="Theme Settings">
      <div class="section-header">
        <ng-icon name="solarPaletteLinear" class="section-icon" />
        <app-section-title>Appearance</app-section-title>
      </div>
      <app-theme-selector />
    </app-card>

    <!-- Reading Preferences -->
    <app-card class="block setting-section" role="region" aria-label="Reading Preferences">
      <div class="section-header">
        <ng-icon name="solarBookLinear" class="section-icon" />
        <app-section-title>Reading Preferences</app-section-title>
      </div>
      <div class="space-y-6">
        <div class="setting-group">
          <div
            class="modern-toggle-container cursor-pointer"
            (click)="toggleSidebarPreference()"
            role="button"
            tabindex="0"
            (keydown.enter)="toggleSidebarPreference()"
            (keydown.space)="toggleSidebarPreference()"
            [attr.aria-label]="
              'Toggle open comments in sidebar on desktop. Currently ' +
              (openCommentsInSidebar() ? 'enabled' : 'disabled')
            "
          >
            <div class="setting-info">
              <label class="setting-title" for="sidebar-toggle">
                Open comments in sidebar on desktop
              </label>
              <p class="setting-description" id="sidebar-toggle-description">
                When enabled, comments will open in a sidebar instead of navigating to a new page
              </p>
            </div>
            <div (click)="$event.stopPropagation()" aria-hidden="true">
              <app-toggle-switch
                id="sidebar-toggle"
                [checked]="openCommentsInSidebar()"
                (checkedChange)="toggleSidebarPreference()"
                ariaLabel="Toggle sidebar preference"
                descriptionId="sidebar-toggle-description"
              />
            </div>
          </div>
        </div>
      </div>
    </app-card>

    <!-- Privacy Redirects Section -->
    <app-card class="block setting-section" role="region" aria-label="Privacy Redirects">
      <div class="section-header">
        <ng-icon name="solarShieldLinear" class="section-icon" />
        <app-section-title>Privacy Redirects</app-section-title>
      </div>

      <!-- Warning when instances not loaded -->
      @if (privacyRedirectEnabled() && privacyRedirectState().error) {
        <div class="privacy-warning" role="alert">
          <ng-icon name="solarDangerTriangleLinear" class="privacy-warning-icon" />
          <div class="privacy-warning-content">
            <div class="privacy-warning-title">Unable to load privacy instances</div>
            <p class="privacy-warning-text">
              {{ privacyRedirectState().error }}
              @if (privacyRedirectState().nextRetryAt) {
                <span> â€¢ Retrying in {{ formatRetryTime() }}</span>
              }
            </p>
            <app-button
              (clicked)="refreshPrivacyInstances()"
              variant="secondary"
              size="sm"
              class="mt-2"
              ariaLabel="Retry loading privacy instances"
            >
              <ng-icon name="solarRefreshLinear" class="mr-2" />
              Retry Now
            </app-button>
          </div>
        </div>
      }

      <div class="space-y-6">
        <div class="setting-group">
          <div
            class="modern-toggle-container cursor-pointer"
            [class.opacity-60]="privacyRedirectState().loading"
            (click)="togglePrivacyRedirect()"
            role="button"
            tabindex="0"
            (keydown.enter)="togglePrivacyRedirect()"
            (keydown.space)="togglePrivacyRedirect()"
            [attr.aria-label]="
              'Toggle privacy redirects. Currently ' +
              (privacyRedirectEnabled() ? 'enabled' : 'disabled')
            "
          >
            <div class="setting-info">
              <label class="setting-title" for="privacy-toggle">
                Redirect links to privacy frontends
              </label>
              <p class="setting-description" id="privacy-toggle-description">
                When enabled, links to sites like Twitter/X will redirect to privacy-respecting
                alternatives (e.g., Nitter). The original URL is still displayed.
              </p>
            </div>
            <div (click)="$event.stopPropagation()" aria-hidden="true">
              <app-toggle-switch
                id="privacy-toggle"
                [checked]="privacyRedirectEnabled()"
                (checkedChange)="togglePrivacyRedirect()"
                ariaLabel="Toggle privacy redirects"
                descriptionId="privacy-toggle-description"
              />
            </div>
          </div>

          <!-- Service list when enabled -->
          @if (privacyRedirectEnabled()) {
            <div class="service-list">
              @for (config of privacyRedirectRegistry; track config.service) {
                <div class="service-item">
                  <div class="service-info">
                    <ng-icon name="solarLinkLinear" class="service-icon" />
                    <span class="service-name">{{ config.displayName }}</span>
                  </div>
                  <app-toggle-switch
                    [checked]="isServiceEnabled(config.service)"
                    (checkedChange)="togglePrivacyService(config.service)"
                    [ariaLabel]="'Toggle ' + config.displayName + ' redirect'"
                  />
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Attribution footer -->
      <div class="attribution-footer">
        Instance data powered by
        <a
          href="https://libredirect.github.io/"
          target="_blank"
          rel="noopener noreferrer"
          class="attribution-link"
        >
          LibRedirect
        </a>
      </div>
    </app-card>

    <!-- User Tags Section -->
    <app-card class="block setting-section" role="region" aria-label="User Tags Management">
      <div class="section-header">
        <ng-icon name="solarTagLinear" class="section-icon" />
        <app-section-title>User Tags</app-section-title>
      </div>

      @if (message()) {
        <div [class]="isError() ? 'alert-danger' : 'alert-success'">{{ message() }}</div>
      }

      <!-- Search and Filter -->
      <div class="tags-search-section">
        <div class="search-container">
          <div class="relative">
            <input
              type="search"
              [ngModel]="searchQuery()"
              (ngModelChange)="onSearchChange($event)"
              placeholder="Search by username or tag..."
              aria-label="Search user tags"
              class="search-input"
              data-lpignore="true"
            />
            <ng-icon name="solarMagniferLinear" class="search-icon" />
            @if (searchQuery()) {
              <button (click)="clearSearch()" class="clear-search" aria-label="Clear search">
                <ng-icon name="solarCloseCircleLinear" />
              </button>
            }
          </div>
          @if (searchQuery()) {
            <div class="search-results-info">
              Found {{ paginatedTags().totalCount }}
              {{ paginatedTags().totalCount === 1 ? 'tag' : 'tags' }}
              @if (searchQuery()) {
                for "{{ searchQuery() }}"
              }
            </div>
          }
        </div>
      </div>

      <!-- Tags Overview -->
      <div class="tags-overview">
        @if (paginatedTags().tags.length > 0) {
          <div class="tags-list">
            @for (tag of paginatedTags().tags; track tag.username) {
              <div class="tag-item-modern">
                <div class="tag-content">
                  <div class="tag-user-info">
                    <ng-icon name="solarUserLinear" class="user-icon" />
                    <a
                      class="tag-username"
                      [routerLink]="['/user', tag.username]"
                      [attr.aria-label]="'View profile for ' + tag.username"
                      [title]="tag.username"
                    >
                      {{ tag.username }}
                    </a>
                    <span class="tag-badge" [style.background-color]="tag.color" [title]="tag.tag">
                      {{ tag.tag }}
                    </span>
                  </div>
                </div>
                <button
                  (click)="removeTag(tag.username)"
                  class="tag-remove-modern"
                  type="button"
                  [title]="'Remove tag for ' + tag.username"
                  [attr.aria-label]="'Remove tag for ' + tag.username"
                  (keydown.enter)="removeTag(tag.username)"
                  (keydown.space)="removeTag(tag.username)"
                >
                  <ng-icon name="solarCloseCircleLinear" />
                </button>
              </div>
            }
          </div>

          <!-- Pagination -->
          @if (paginatedTags().totalPages > 1) {
            <app-pagination
              [currentPage]="paginatedTags().currentPage"
              [totalPages]="paginatedTags().totalPages"
              [totalCount]="paginatedTags().totalCount"
              [itemsPerPage]="itemsPerPage()"
              (pageChange)="onPageChange($event)"
              (itemsPerPageChange)="onItemsPerPageChange($event)"
            />
          }
        } @else if (searchQuery()) {
          <div class="empty-state">
            <ng-icon name="solarMagniferLinear" class="empty-icon" />
            <h4 class="empty-title">No tags found</h4>
            <p class="empty-description">
              No tags match "{{ searchQuery() }}". Try a different search term or clear the search
              to see all tags.
            </p>
            <app-button
              (clicked)="clearSearch()"
              variant="secondary"
              size="sm"
              ariaLabel="Clear search"
            >
              <ng-icon name="solarCloseCircleLinear" class="mr-2" />
              Clear Search
            </app-button>
          </div>
        } @else {
          <div class="empty-state">
            <ng-icon name="solarTagLinear" class="empty-icon" />
            <h4 class="empty-title">No tags yet</h4>
            <p class="empty-description">
              Start tagging users while browsing stories and comments. Your tags will help you
              remember interesting contributors.
            </p>
          </div>
        }

        <!-- Import/Export and Clear All Actions -->
        <div class="tag-action-buttons">
          <app-button
            (clicked)="exportTags()"
            variant="secondary"
            size="sm"
            ariaLabel="Export user tags"
            [disabled]="tags().length === 0"
          >
            <ng-icon name="solarExportLinear" class="hidden sm:inline mr-2" />
            Export
          </app-button>
          <app-button
            (clicked)="fileInput.click()"
            variant="secondary"
            size="sm"
            ariaLabel="Import user tags"
          >
            <ng-icon name="solarImportLinear" class="hidden sm:inline mr-2" />
            Import
          </app-button>
          <input
            #fileInput
            type="file"
            accept=".json"
            (change)="importTags($event)"
            class="hidden"
            aria-hidden="true"
          />
          @if (tags().length > 0) {
            <app-button
              (clicked)="clearAll()"
              variant="danger"
              size="sm"
              ariaLabel="Clear all user tags"
            >
              <ng-icon name="solarTrashBinTrashLinear" class="hidden sm:inline mr-2" />
              Clear Tags
            </app-button>
          }
        </div>
      </div>
    </app-card>

    <!-- Cache Management Section -->
    <app-card class="block setting-section" role="region" aria-label="Cache Management">
      <div class="section-header">
        <ng-icon name="solarDatabaseLinear" class="section-icon" />
        <app-section-title>Cache Management</app-section-title>
      </div>

      <div class="space-y-8">
        <!-- Cache Statistics -->
        <div class="cache-stats-section">
          <div class="stats-header">
            <h3 class="stats-title">
              <ng-icon name="solarChartLinear" class="mr-2" />
              Storage Statistics
            </h3>
            <app-button
              (clicked)="refreshStats()"
              variant="secondary"
              size="sm"
              ariaLabel="Refresh cache statistics"
            >
              <ng-icon name="solarRefreshLinear" class="mr-2" />
              Refresh
            </app-button>
          </div>

          <div class="stats-grid">
            <div class="stat-card-modern">
              <div class="stat-icon indexeddb">
                <ng-icon name="solarSSDRoundLinear" />
              </div>
              <div class="stat-content">
                <div class="stat-label">IndexedDB Storage</div>
                <div class="stat-value">{{ formatBytes(cacheStats().indexedDB) }}</div>
              </div>
            </div>

            <div class="stat-card-modern">
              <div class="stat-icon sw-cache">
                <ng-icon name="solarGalleryLinear" />
              </div>
              <div class="stat-content">
                <div class="stat-label">Service Worker Cache</div>
                <div class="stat-value">{{ formatBytes(cacheStats().swCache) }}</div>
              </div>
            </div>

            <div class="stat-card-modern">
              <div class="stat-icon items">
                <ng-icon name="solarDatabaseLinear" />
              </div>
              <div class="stat-content">
                <div class="stat-label">Cached Items</div>
                <div class="stat-value">{{ cacheStats().itemCount }}</div>
              </div>
            </div>

            <div class="stat-card-modern">
              <div class="stat-icon memory">
                <ng-icon name="solarCPULinear" />
              </div>
              <div class="stat-content">
                <div class="stat-label">Memory Cache</div>
                <div class="stat-value">{{ cacheStats().memoryItems }} items</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cache Actions -->
        <div class="cache-actions-section">
          <div class="cache-actions-header">
            <h3 class="actions-title">
              <ng-icon name="solarTrashBinTrashLinear" class="mr-2" />
              Clear Cache Data
            </h3>
          </div>
          <p class="actions-description">
            Free up storage space by clearing cached data. The app will re-download content as
            needed.
          </p>
          <div class="action-buttons">
            <app-button
              (clicked)="clearCache('stories')"
              variant="secondary"
              size="sm"
              ariaLabel="Clear story cache"
            >
              Clear Stories
            </app-button>
            <app-button
              (clicked)="clearCache('images')"
              variant="secondary"
              size="sm"
              ariaLabel="Clear image cache"
            >
              Clear Images
            </app-button>
            <app-button
              (clicked)="clearCache('all')"
              variant="danger"
              size="sm"
              ariaLabel="Clear all cached data"
            >
              Clear All Cache
            </app-button>
          </div>
        </div>

        @if (cacheMessage()) {
          <div [class]="cacheError() ? 'alert-danger' : 'alert-success'">
            {{ cacheMessage() }}
          </div>
        }
      </div>
    </app-card>
  </div>
</app-page-container>
