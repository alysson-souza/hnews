@if (showLoadButton()) {
  <!-- Lazy load button -->
  <div
    class="mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg"
    [ngClass]="depth > 0 ? 'ml-2 sm:ml-4' : ''"
  >
    <button
      (click)="loadComment()"
      [disabled]="loading()"
      class="text-blue-600 hover:text-blue-800 text-sm font-medium disabled:opacity-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded"
    >
      @if (loading()) {
        <span class="flex items-center gap-2">
          <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          Loading comment...
        </span>
      } @else {
        Load comment
      }
    </button>
  </div>
} @else if (loading()) {
  <div
    class="animate-pulse mb-4"
    [ngClass]="depth > 0 ? 'ml-4 border-l-2 border-gray-200 pl-4' : ''"
  >
    <div class="h-4 bg-gray-200 rounded w-1/4 mb-2"></div>
    <div class="h-3 bg-gray-200 rounded w-3/4"></div>
  </div>
} @else if (comment()) {
  <div
    class="mb-4"
    [ngClass]="depth > 0 ? 'ml-2 sm:ml-4 border-l-2 border-gray-200 pl-2 sm:pl-4' : ''"
  >
    <!-- Comment Header -->
    <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-600 mb-1">
      <!-- Vote Button -->
      <button
        (click)="upvoteComment()"
        [class.text-blue-600]="!hasVoted()"
        [class.text-gray-400]="hasVoted()"
        [class.opacity-50]="hasVoted()"
        [disabled]="hasVoted()"
        class="hover:scale-110 transition-transform cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded"
        [attr.aria-label]="hasVoted() ? 'Already upvoted comment' : 'Upvote comment'"
        [attr.aria-pressed]="hasVoted()"
      >
        <svg
          class="w-3 h-3 sm:w-4 sm:h-4"
          fill="currentColor"
          viewBox="0 0 20 20"
          aria-hidden="true"
        >
          <path d="M10 3L3 10h4v7h6v-7h4L10 3z" />
        </svg>
      </button>

      <!-- Author -->
      @if (comment()!.by) {
        <app-user-tag [username]="comment()!.by!"></app-user-tag>
      }

      <!-- Time -->
      <span class="text-gray-500">{{ getTimeAgo(comment()!.time) }}</span>

      <!-- Collapse Button (for loaded replies) -->
      @if (replies().length > 0) {
        <button
          (click)="toggleCollapse()"
          class="text-gray-400 hover:text-gray-600 ml-2 cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded px-1"
          [attr.aria-label]="isCollapsed() ? 'Expand thread' : 'Collapse thread'"
          [attr.aria-expanded]="!isCollapsed()"
        >
          <span class="text-xs"> [{{ isCollapsed() ? '+' : 'âˆ’' }}] </span>
        </button>
      }

      <!-- Expand Button (for unloaded replies) -->
      @if (showExpandButton()) {
        <button
          (click)="expandReplies()"
          [disabled]="loadingReplies()"
          class="text-blue-600 hover:text-blue-800 ml-2 cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded px-1 text-xs disabled:opacity-50"
          [attr.aria-label]="'Expand ' + totalRepliesCount() + ' replies'"
        >
          @if (loadingReplies()) {
            <span class="flex items-center gap-1">
              <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              Loading...
            </span>
          } @else {
            [+{{ totalRepliesCount() }} replies]
          }
        </button>
      }
    </div>

    <!-- Comment Content -->
    @if (!isCollapsed()) {
      <div
        class="prose prose-xs sm:prose-sm max-w-none text-gray-800 mb-2 text-sm sm:text-base"
        [innerHTML]="comment()!.text"
      ></div>

      <!-- Nested Replies -->
      @if (replies().length > 0 || loadingReplies()) {
        <div class="mt-2">
          <!-- Loading indicator for first batch -->
          @if (loadingReplies() && replies().length === 0) {
            <div class="ml-2 sm:ml-4 py-2">
              <div class="flex items-center gap-2 text-sm text-gray-500">
                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                Loading replies...
              </div>
            </div>
          }

          <!-- Actual replies -->
          @for (reply of replies(); track reply.id) {
            @if (reply.kids && reply.kids.length > 0) {
              <app-comment-thread [commentId]="reply.id" [depth]="depth + 1" [lazyLoad]="true">
              </app-comment-thread>
            } @else {
              <!-- Inline simple replies without kids -->
              <div class="mb-3 ml-2 sm:ml-4 border-l-2 border-gray-200 pl-2 sm:pl-4">
                <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-600 mb-1">
                  @if (reply.by) {
                    <app-user-tag [username]="reply.by!"></app-user-tag>
                  }
                  <span class="text-gray-500">{{ getTimeAgo(reply.time) }}</span>
                </div>
                <div
                  class="prose prose-xs sm:prose-sm max-w-none text-gray-800 text-sm sm:text-base"
                  [innerHTML]="reply.text"
                ></div>
              </div>
            }
          }

          <!-- Load More Button -->
          @if (hasMoreReplies()) {
            <div class="mt-3 ml-2 sm:ml-4">
              <button
                (click)="loadMoreReplies()"
                [disabled]="loadingMore()"
                class="px-3 py-1 text-xs sm:text-sm bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
              >
                @if (loadingMore()) {
                  <span class="flex items-center gap-1">
                    <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                      ></path>
                    </svg>
                    Loading...
                  </span>
                } @else {
                  Load {{ remainingRepliesCount }} more replies
                }
              </button>
            </div>
          }
        </div>
      }
    } @else {
      <span class="text-sm text-gray-500 italic">[collapsed]</span>
    }
  </div>
}
