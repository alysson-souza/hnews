<article class="story-card" [class.story-card-selected]="isSelected" role="article">
  <!-- Visited indicator -->
  @if (!isLoading() && story) {
    <app-visited-indicator [storyId]="story!.id"></app-visited-indicator>
  }

  <!-- Responsive Vote Section -->
  @if (deviceService.isMobile()) {
    <!-- Mobile Vote Section (No Thumbnails) -->
    <div class="vote-section-mobile flex items-center gap-2">
      @if (isLoading()) {
        <div class="w-6 h-6 bg-gray-300 rounded skeleton"></div>
        <div class="w-12 h-6 bg-gray-300 rounded skeleton"></div>
      } @else {
        <button
          (click)="upvote()"
          class="vote-button"
          [class.vote-button-active]="!hasVoted()"
          [class.vote-button-voted]="hasVoted()"
          [disabled]="hasVoted()"
          [attr.aria-label]="hasVoted() ? 'Already Upvoted' : 'Upvote Story'"
          [attr.aria-pressed]="hasVoted()"
          [title]="hasVoted() ? 'Already Upvoted' : 'Upvote Story'"
        >
          <svg class="w-6 h-6 fill-current" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M10 3L3 10h4v7h6v-7h4L10 3z" />
          </svg>
        </button>
        <span
          class="vote-count text-xl"
          [class.vote-count-active]="!hasVoted()"
          [class.vote-count-voted]="hasVoted()"
        >
          {{ (story!.score || 0) + (hasVoted() ? 1 : 0) }}
        </span>
      }
    </div>
  } @else {
    <!-- Desktop Vote Section -->
    <div class="vote-section flex flex-col w-[100px] flex-shrink-0">
      @if (isLoading()) {
        <div class="w-8 h-8 bg-gray-300 rounded mb-2 skeleton"></div>
        <div class="w-12 h-6 bg-gray-300 rounded skeleton"></div>
      } @else {
        <button
          (click)="upvote()"
          class="vote-button"
          [class.vote-button-active]="!hasVoted()"
          [class.vote-button-voted]="hasVoted()"
          [disabled]="hasVoted()"
          [attr.aria-label]="hasVoted() ? 'Already Upvoted' : 'Upvote Story'"
          [attr.aria-pressed]="hasVoted()"
          [title]="hasVoted() ? 'Already Upvoted' : 'Upvote Story'"
        >
          <svg class="w-8 h-8 fill-current" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M10 3L3 10h4v7h6v-7h4L10 3z" />
          </svg>
        </button>
        <span
          class="vote-count text-2xl"
          [class.vote-count-active]="!hasVoted()"
          [class.vote-count-voted]="hasVoted()"
        >
          {{ (story!.score || 0) + (hasVoted() ? 1 : 0) }}
        </span>
      }
    </div>
  }

  <!-- Desktop Thumbnail -->
  <div class="hidden sm:flex flex-shrink-0 w-28 items-center justify-center p-3">
    @if (isLoading()) {
      <div class="w-20 h-20 bg-gray-200 skeleton"></div>
    } @else {
      <app-story-thumbnail
        [storyUrl]="story!.url"
        [storyTitle]="story!.title || ''"
        [isTextPost]="isTextPost()"
        (linkClicked)="markAsVisited()"
      >
      </app-story-thumbnail>
    }
  </div>

  <!-- Content -->
  <div class="flex-1 p-3 min-w-0 overflow-hidden">
    <div class="flex items-start justify-between gap-2">
      <div class="flex-1 min-w-0 overflow-hidden">
        <!-- Title -->
        @if (isLoading()) {
          <div class="h-6 sm:h-7 bg-gray-200 rounded w-3/4 mb-1 mt-1 skeleton"></div>
        } @else {
          <h2
            class="story-title"
            [class.story-title-unread]="!isVisited()"
            [class.story-title-visited]="isVisited()"
          >
            @if (story!.url) {
              <a
                [href]="story!.url"
                target="_blank"
                rel="noopener noreferrer nofollow"
                (click)="markAsVisited()"
                class="story-title-link story-link-trigger cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded"
              >
                {{ story!.title }}
              </a>
            } @else {
              <a
                [routerLink]="['/item', story!.id]"
                (click)="markAsVisited()"
                class="story-title-link story-link-trigger cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded"
              >
                {{ story!.title }}
              </a>
            }
          </h2>
        }

        <!-- Domain - Now clickable -->
        @if (isLoading()) {
          <div class="h-4 bg-gray-200 rounded w-32 mb-1 skeleton"></div>
        } @else if (story!.url && getDomain(story!.url)) {
          <button
            type="button"
            (click)="searchByDomain($event)"
            (keyup.enter)="searchByDomain($event)"
            (keyup.space)="searchByDomain($event)"
            class="domain-btn"
            [attr.aria-label]="'Search For More Stories From ' + getDomain(story!.url)"
            [title]="'Search For More Stories From ' + getDomain(story!.url)"
          >
            ({{ getDomain(story!.url) }})
          </button>
        }

        <!-- Metadata -->
        <div class="story-meta mt-2 overflow-hidden">
          @if (isLoading()) {
            <div class="flex items-center gap-3">
              <div class="h-3 bg-gray-200 rounded w-20 skeleton"></div>
              <div class="h-3 bg-gray-200 rounded w-24 skeleton"></div>
              <div class="h-3 bg-gray-200 rounded w-28 skeleton"></div>
            </div>
          } @else {
            @if (story!.by) {
              <span class="inline-flex items-center gap-1">
                by
                <app-user-tag [username]="story!.by!"></app-user-tag>
              </span>
            }
            <span class="hidden sm:inline" aria-hidden="true">•</span>
            <span class="story-time">{{ getTimeAgo(story!.time) }}</span>
            <span class="hidden sm:inline" aria-hidden="true">•</span>
            @if (openCommentsInSidebar()) {
              <a
                [attr.href]="getItemLink()"
                (click)="openComments($event)"
                (auxclick)="openComments($event)"
                (keyup.enter)="openComments($any($event))"
                (keyup.space)="openComments($any($event))"
                class="story-comments story-comments-trigger focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded"
                [attr.aria-label]="'View ' + (story!.descendants || 0) + ' Comments'"
                [title]="getCommentTooltip()"
              >
                {{ story!.descendants || 0 }}
                {{ story!.descendants === 1 ? 'comment' : 'comments' }}
                @if (hasNewComments()) {
                  <span class="new-comments-badge">[+{{ getNewCommentCount() }}]</span>
                }
              </a>
            } @else {
              <a
                [routerLink]="['/item', story!.id]"
                (click)="openComments($event)"
                (auxclick)="openComments($event)"
                (keyup.enter)="openComments($any($event))"
                (keyup.space)="openComments($any($event))"
                class="story-comments story-comments-trigger focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 rounded"
                [attr.aria-label]="'View ' + (story!.descendants || 0) + ' Comments'"
                [title]="getCommentTooltip()"
              >
                {{ story!.descendants || 0 }}
                {{ story!.descendants === 1 ? 'comment' : 'comments' }}
                @if (hasNewComments()) {
                  <span class="new-comments-badge">[+{{ getNewCommentCount() }}]</span>
                }
              </a>
            }
          }
        </div>
      </div>

      <!-- Actions Button -->
      <div class="story-actions-container relative ml-2 sm:ml-0 flex-shrink-0">
        @if (isLoading()) {
          <div class="w-9 h-9 bg-gray-200 rounded skeleton"></div>
        } @else {
          <button
            #actionsBtn
            (click)="toggleActionsMenu($event)"
            class="story-actions-btn"
            [attr.aria-label]="'Open Actions Menu'"
            [attr.aria-haspopup]="'menu'"
            [attr.aria-expanded]="showActionsMenu"
            [attr.aria-controls]="'actions-menu-' + story!.id"
            [attr.id]="'actions-btn-' + story!.id"
            [title]="'More Actions'"
          >
            <fa-icon [icon]="faEllipsisVertical" class="text-[16px] sm:text-[20px]"></fa-icon>
          </button>
        }

        <!-- Actions Menu Popup -->
        @if (showActionsMenu && !isLoading()) {
          <div
            #actionsMenu
            class="story-actions-menu story-actions-menu-fixed"
            role="menu"
            [attr.id]="'actions-menu-' + story!.id"
            [attr.aria-labelledby]="'actions-btn-' + story!.id"
            [style.top.px]="actionsMenuTop"
            [style.left.px]="actionsMenuLeft"
          >
            <button
              (click)="shareStory()"
              class="story-actions-item story-actions-item-top"
              role="menuitem"
            >
              {{ getStoryActionText() }}
            </button>
            <button (click)="shareComments()" class="story-actions-item" role="menuitem">
              {{ getCommentsActionText() }}
            </button>
            <button
              (click)="openCommentsInNewTab()"
              class="story-actions-item story-actions-divider story-actions-item-bottom"
              role="menuitem"
            >
              Open Comments in New Tab
            </button>
          </div>
        }
      </div>
    </div>
  </div>
</article>
